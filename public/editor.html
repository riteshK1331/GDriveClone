<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>File Editor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
    header { padding: 12px 16px; background: #1976d2; color: white; display:flex; align-items:center; justify-content:space-between }
    main { flex: 1; padding: 12px; display:flex; flex-direction:column }
    textarea { flex: 1; width: 100%; resize: none; font-family: monospace; font-size: 14px; padding: 12px; box-sizing: border-box }
    .meta { color: rgba(255,255,255,0.9) }
    .controls { display:flex; gap:8px }
    button { padding:8px 12px; font-size:14px; }
  </style>
</head>
<body>
  <header>
    <div class="meta">Editor</div>
    <div class="controls">
      <button id="saveBtn">Save</button>
      <button id="downloadBtn">Download</button>
      <button id="closeBtn">Close</button>
    </div>
  </header>
  <main>
    <div id="info" style="margin-bottom:8px;color:#333"></div>
    <textarea id="editor" placeholder="Loading..." />
  </main>

  <script>
    function qs(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name);
    }

    const folder = qs('folder') || '';
    const disk = qs('disk') || qs('file') || '';
    const name = qs('name') || disk || '';

    const info = document.getElementById('info');
    const editor = document.getElementById('editor');
    const saveBtn = document.getElementById('saveBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const closeBtn = document.getElementById('closeBtn');

    const origin = location.origin;
    let filePath = '';
    let fetchPath = '';
    
    if (folder && folder !== '') {
      filePath = `${origin}/${folder}/${disk}`;
      fetchPath = `http://localhost:3000/${folder}/${disk}`;
    } else {
      filePath = `${origin}/uploads/${disk}`;
      fetchPath = `http://localhost:3000/uploads/${disk}`;
    }

    info.textContent = `File: ${name} — Loading from: ${fetchPath}`;

    // Fetch the file as text
    fetch(fetchPath).then(async res => {
      if (!res.ok) throw new Error(`Failed to fetch file (${res.status}: ${res.statusText})`)
      const txt = await res.text();
      editor.value = txt;
      info.textContent = `File: ${name} — ${filePath} (loaded)`;
    }).catch(err => {
      editor.value = `Unable to load file for editing: ${err.message}\n\nTried path: ${fetchPath}`;
      info.textContent = `Error loading file: ${err.message}`;
    })

    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([editor.value], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name || disk || 'file.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    saveBtn.addEventListener('click', async () => {
      saveBtn.disabled = true
      saveBtn.textContent = 'Saving...'
      try {
        const res = await fetch('http://localhost:5001/api/files/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ folder: folder, diskName: disk, content: editor.value, name })
        })
        if (!res.ok) {
          const txt = await res.text()
          alert('Save failed: ' + txt)
        } else {
          alert('Saved successfully')
        }
      } catch (err) {
        alert('Save error: ' + err.message)
      } finally {
        saveBtn.disabled = false
        saveBtn.textContent = 'Save'
      }
    })

    closeBtn.addEventListener('click', () => {
      window.close();
    });
  </script>
</body>
</html>